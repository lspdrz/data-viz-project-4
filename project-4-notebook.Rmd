---
title: "GP4"
author: "Sally Abekhe, Joshua Cosme, Luis Pedraza"
date: "11/15/2017"
output:
  html_notebook:
    code_folding: show
    toc: yes
    toc_depth: 4
    toc_float: yes
runtime: shiny
resource_files:
- .renviron
- .Renviron
---
```{r setup, include=FALSE}
library(tidyverse)
require(data.world)
knitr::opts_chunk$set(echo = TRUE)
```
  
## **R Session Info**  

```{r}
sessionInfo()
```

## **Github Link**
https://github.com/tonypedraza/data-viz-project-4

## **Connecting to data.world**
Below, we connect our data.world project to this notebook.
```{r}
dataset_key <- "https://data.world/tonypedraza/f-17-edv-project-4"
data.world::set_config(cfg_env("DW_API"))
```

## **Introduction** 
This R notebook displays how to clean, export, input, reformat, and transform data in R.

## **Cleaning the Data**
Below, we read and clean a dataset by passing an argument to read_csv.

```{r}
require(tidyverse)
require(dplyr)
powerBall <- read_csv("preCensusMergeData.csv", 
col_types = cols(
  fy11 = col_number(),
  fy12 = col_number(),
  fy13 = col_number(),
  fy14 = col_number(),
  county = col_character(),
  merge_loc = col_character()
))

# Add the sales per year for the each county, aggregate the counties, and remove the original sales columns
powerBall <- powerBall %>% group_by(merge_loc) %>% 
  mutate(salesfy11 = sum(fy11, na.rm = TRUE)) %>%
  mutate(salesfy12 = sum(fy12, na.rm = TRUE)) %>%
  mutate(salesfy13 = sum(fy13, na.rm = TRUE)) %>%
  mutate(salesfy14 = sum(fy14, na.rm=TRUE)) %>%
  distinct(county, merge_loc, salesfy11, salesfy12, salesfy13, salesfy14)
```


Then we write the cleaned dataset to a new csv file.

```{r}
write_csv(powerBall, "powerball.csv")
```


We then upload this file to data.world so we can join it with the census data.

## **Analysis**

First, we have to import the newly joined dataset from data.world into this notebook:

```{r}

# The SQL query to join the datasets in data.world
sqlQuery <- data.world::qry_sql("with q1 as(SELECT powerball.county, powerball.salesfy11, powerball.salesfy12, 
  powerball.salesfy13, powerball.salesfy14, powerball.merge_loc, il.b17001_002 population_living_in_poverty
  FROM powerball left join il on powerball.merge_loc = il.areaname)

  SELECT q1.county, q1.salesfy11, q1.salesfy12, q1.salesfy13, q1.salesfy14, 
  q1.population_living_in_poverty, ilpop.b11002_001 total_population
  FROM q1 left join ilpop on q1.merge_loc = ilpop.areaname"
)

# Import the data set returned by the query into a local data frame
powerBallCensusMerged <- data.world::query(sqlQuery, dataset=dataset_key)

```








